
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zones of Regulation</title>
  <style>
    body { font-family: 'Quicksand', sans-serif; margin: 20px; background: #f9fbfd; }
    .student-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 10px; }
    .student { background: #d6ecff; padding: 10px; border-radius: 8px; cursor: grab; }
    .zone-container { display: flex; gap: 20px; margin-top: 20px; }
    .zone { flex: 1; min-height: 200px; background: #e0e0e0; border-radius: 10px; padding: 10px; position: relative; }
    .icon { font-size: 24px; margin: 5px; }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .controls button { padding: 8px 12px; background: #cce5ff; border: none; border-radius: 6px; cursor: pointer; }
    .controls a { text-decoration: none; font-weight: bold; color: #333; }
  </style>
</head>
<body>
  <div class="controls">
    <div>
      <label for="sessionSelect">Choose Session:</label>
      <select id="sessionSelect"></select>
    </div>
    <div>
      <button id="resetAll">🔄 Reset</button>
      <a href="teacher-dashboard.html">📊 Dashboard</a>
    </div>
  </div>

  <div class="student-grid"></div>

  <div class="zone-container">
    <div class="zone" data-zone="blue" style="background:#cce5ff;">Blue Zone</div>
    <div class="zone" data-zone="green" style="background:#d4edda;">Green Zone</div>
    <div class="zone" data-zone="yellow" style="background:#fff3cd;">Yellow Zone</div>
    <div class="zone" data-zone="red" style="background:#f8d7da;">Red Zone</div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, collection } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTmZv-gavHAECU5kqjTyrdABfsk_oonsM",
    authDomain: "zonesdashboard.firebaseapp.com",
    projectId: "zonesdashboard",
    storageBucket: "zonesdashboard.firebasestorage.app",
    messagingSenderId: "121203751843",
    appId: "1:121203751843:web:1ccb23a0fcbd09fe25b816",
    measurementId: "G-CB8EVKZ0HF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore(app);

  let currentUser = null;
  let currentClass = "Default";
  let currentSession = "Session 1";
  let sessionCount = 3;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "index.html";
    currentUser = user;
    await loadSessionPreference();
    buildSessionSelector();
    await loadStudentList();
  });

  async function loadSessionPreference() {
    const userRef = doc(db, "users", currentUser.uid);
    const snap = await getDoc(userRef);
    sessionCount = (snap.exists() && snap.data().sessionCount) || 3;
  }

  function buildSessionSelector() {
    const sessionSelect = document.getElementById("sessionSelect");
    sessionSelect.innerHTML = "";
    for (let i = 1; i <= sessionCount; i++) {
      const opt = document.createElement("option");
      opt.value = `Session ${i}`;
      opt.textContent = `Session ${i}`;
      sessionSelect.appendChild(opt);
    }
    sessionSelect.addEventListener("change", (e) => {
      currentSession = e.target.value;
    });
  }

  async function loadStudentList() {
    const ref = doc(db, "users", currentUser.uid, "classes", currentClass);
    const snap = await getDoc(ref);
    const students = snap.exists() ? (snap.data().students || []) : [];
    const grid = document.querySelector(".student-grid");
    grid.innerHTML = "";

    students.forEach(name => {
      const div = document.createElement("div");
      div.className = "student";
      div.textContent = name;
      div.setAttribute("draggable", "true");
      grid.appendChild(div);
    });

    setupDragAndDrop();
  }

  function setupDragAndDrop() {
    document.querySelectorAll(".student").forEach(el => {
      el.addEventListener("dragstart", (e) => {
        if (el.classList.contains("disabled")) {
          e.preventDefault();
        } else {
          e.dataTransfer.setData("text", e.target.textContent);
        }
      });

      el.addEventListener("dblclick", () => {
        el.classList.remove("disabled");
        el.style.opacity = "1";
        el.setAttribute("draggable", "true");
        document.querySelectorAll(".zone .icon").forEach(icon => {
          if (icon.dataset.name === el.textContent) icon.remove();
        });
      });
    });

    document.querySelectorAll(".zone").forEach(zone => {
      zone.addEventListener("dragover", (e) => e.preventDefault());
      zone.addEventListener("drop", async (e) => {
        e.preventDefault();
        const name = e.dataTransfer.getData("text");
        const zoneColor = zone.dataset.zone;
        const icon = document.createElement("div");
        icon.className = "icon";
        icon.textContent = "🐝";
        icon.dataset.name = name;
        zone.appendChild(icon);

        const studentEl = Array.from(document.querySelectorAll(".student")).find(el => el.textContent === name);
        if (studentEl) {
          studentEl.classList.add("disabled");
          studentEl.setAttribute("draggable", "false");
          studentEl.style.opacity = "0.5";
        }

        const date = new Date().toISOString().split("T")[0];
        const docRef = doc(db, "users", currentUser.uid, "logs", date);
        const docSnap = await getDoc(docRef);

        const newEntry = { name, zone: zoneColor, className: currentClass, session: currentSession };

        if (!docSnap.exists()) {
          await setDoc(docRef, { entries: [newEntry] });
        } else {
          await updateDoc(docRef, {
            entries: arrayUnion(newEntry)
          });
        }
      });
    });

    document.getElementById("resetAll").addEventListener("click", () => {
      document.querySelectorAll(".zone .icon").forEach(el => el.remove());
      document.querySelectorAll(".student").forEach(el => {
        el.classList.remove("disabled");
        el.setAttribute("draggable", "true");
        el.style.opacity = "1";
      });
    });
  }
</script>

</body>
</html>
